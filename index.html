<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <title>QR Scanner Alati</title>
  <script src="https://unpkg.com/html5-qrcode@2.3.7/minified/html5-qrcode.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #reader { width: 300px; margin-bottom: 20px; }
    #result { border: 1px solid #ccc; padding: 10px; max-width: 600px; min-height: 120px; }
    button { padding: 10px 15px; font-size: 16px; margin-right: 10px; cursor: pointer; }
    img { max-width: 100px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>QR Scanner za alate</h1>

  <button id="start-btn">Pokreni kameru</button>
  <button id="stop-btn" disabled>Zaustavi kameru</button>

  <div id="reader"></div>
  <div id="result">Skeniraj QR kod da vidiš detalje alata.</div>

  <script>
    const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxISLSuUi8FuPQObh-Z7OeYGoMOXAO066xpt9MCC0vbiTl8OiGVdKtuQp4vbVu3PETJVA/exec';
    let alatData = [];
    let html5QrCode;

    // Učitaj podatke iz Google Sheets API-ja
    function loadSheetData() {
      return fetch(SHEET_URL)
        .then(res => res.json())
        .then(data => {
          alatData = data;
          console.log('Podaci učitani:', alatData.length);
        })
        .catch(err => {
          console.error('Greška u dohvaćanju podataka:', err);
          document.getElementById('result').innerText = 'Greška u dohvaćanju podataka.';
        });
    }

    // Pronađi alat po ID-u i prikaži informacije
    function prikaziAlat(id) {
      const alat = alatData.find(a => a.id == id);
      const rez = document.getElementById('result');
      if (!alat) {
        rez.innerHTML = `<p style="color:red;">Alat nije pronađen (ID: ${id})</p>`;
        return;
      }
      rez.innerHTML = `
        <h2>${alat.naziv}</h2>
        <p><strong>Šifra:</strong> ${alat.sifra}</p>
        <p><strong>Cijena:</strong> ${alat.cijena} kn</p>
        <p><strong>Cijena s rabatom:</strong> ${alat.cijena_rabat} kn</p>
        ${alat.slika ? `<img src="${alat.slika}" alt="${alat.naziv}">` : ''}
        <p>${alat.opis || ''}</p>
      `;
    }

    // Funkcije za start i stop kamere
    function startScanner() {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          console.log(`Skeniran QR kod: ${qrCodeMessage}`);
          prikaziAlat(qrCodeMessage.trim());
          html5QrCode.stop();
          stopBtn.disabled = true;
          startBtn.disabled = false;
        },
        errorMessage => {
          // opcionalno možeš logirati greške
        }
      ).then(() => {
        document.getElementById('result').innerText = 'Kamera je pokrenuta, skeniraj QR kod...';
        startBtn.disabled = true;
        stopBtn.disabled = false;
      }).catch(err => {
        document.getElementById('result').innerText = 'Nema pristupa kameri: ' + err;
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          document.getElementById('result').innerText = 'Kamera je zaustavljena.';
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }).catch(err => {
          document.getElementById('result').innerText = 'Greška pri zaustavljanju kamere: ' + err;
        });
      }
    }

    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click', stopScanner);

    // Prvo učitaj podatke, ali ne pokreći kameru odmah (čekaj klik na start)
    loadSheetData();
  </script>
</body>
</html>
